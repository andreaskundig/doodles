!function(){"use strict";var l=function(e,t,n){return e+n*(t-e)},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},d=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&a.return&&a.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=function(){function h(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:h.getRandomSeed(),t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:h.getRandomTime(),n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:h.getRandomSharpness();r(this,h),this.seed=e,this.time=t,this.sharpness=n}return s(h,[{key:"randomize",value:function(){this.seed=h.getRandomSeed(),this.time=h.getRandomTime(),this.sharpness=h.getRandomSharpness()}},{key:"toString",value:function(){return this.seed+"|"+this.time+"|"+this.sharpness}}],[{key:"getRandomSeed",value:function(){return Math.floor(l(h.SEED_MIN,h.SEED_MAX,Math.random()))}},{key:"getRandomTime",value:function(){var e=Math.pow(10,h.TIME_PRECISION),t=l(h.TIME_MIN,h.TIME_MAX,Math.random());return Math.floor(t*e)/e}},{key:"getRandomSharpness",value:function(){return Math.floor(l(h.SHARPNESS_MIN,h.SHARPNESS_MAX,Math.random()))}},{key:"parse",value:function(e){var t=e.split(/\|/g),n=d(t,3),i=n[0],r=n[1],o=n[2],s=Number.parseInt(i),a=Number.parseFloat(r),u=Number.parseInt(o);return Number.isNaN(s)||Number.isNaN(a)||Number.isNaN(u)?null:new h(s,a,u)}},{key:"SEED_MIN",get:function(){return 0}},{key:"SEED_MAX",get:function(){return Math.floor(.5*Number.MAX_SAFE_INTEGER)}},{key:"TIME_MIN",get:function(){return-8}},{key:"TIME_MAX",get:function(){return 8}},{key:"TIME_PRECISION",get:function(){return 4}},{key:"SHARPNESS_MIN",get:function(){return 0}},{key:"SHARPNESS_MAX",get:function(){return Math.pow(2,12)}}]),h}(),i=function(){function e(){r(this,e),this._handlers={}}return s(e,[{key:"off",value:function(e,t){if("string"!=typeof e)throw new Error('Event "'+e+'" is not a string');if("function"!=typeof t)throw new Error('Handler "'+t+'" is not a function');if(Object.values(this._handlers[e]).includes(t)){var n=this._handlers[e].indexOf(t);this._handlers[e].splice(n)}else console.warn('Handler "'+t+'" is not a registered function')}},{key:"on",value:function(e,t){if("string"!=typeof e)throw new Error('Event "'+e+'" is not a string');if("function"!=typeof t)throw new Error('Handler "'+t+'" is not a function');e in this._handlers||(this._handlers[e]=[]),this._handlers[e].push(t)}},{key:"trigger",value:function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];e in this._handlers&&this._handlers[e].forEach(function(e){return e.apply(void 0,n)})}}]),e}(),t=new(function(e){function t(){r(this,t);var e=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return window.addEventListener("hashchange",function(){return e.trigger("change")}),e}return o(t,i),s(t,[{key:"getRenderSettings",value:function(){return window.location.hash?u.parse(window.location.hash.substr(1)):null}},{key:"persist",value:function(e){if(!(e instanceof u))throw new Error('"'+e+'" should be of type RenderSettingsModel');window.location.hash=e.toString()}}]),t}()),h=function(e){function n(e){r(this,n);var t=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t.element=e,t}return o(n,i),s(n,[{key:"dispose",value:function(){}},{key:"getComponentElement",value:function(e){return this.element.querySelector('[data-component="'+e+'"]')}},{key:"getElement",value:function(e){return this.element.querySelector('[data-ref="'+e+'"]')}}]),n}(),c=function(e,r){if(!(Array.isArray(e)||e instanceof Int8Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array))throw new Error('"'+e+'" is not an Array');if(!Number.isInteger(r))throw new Error('"'+r+' is not an Integer"');return e.reduce(function(e,t,n){var i=Math.floor(n/r);return e.length<=i&&e.push([]),e[i].push(t),e},[])},p=function(){function o(e,t){r(this,o),this.model=o.createModel(e,t)}return s(o,[{key:"dispose",value:function(){tf.dispose(this.model)}},{key:"predict",value:function(t){var n=this;return tf.tidy(function(){var e=tf.tensor2d(t);return c(n.model.predict(e).add(tf.scalar(1)).mul(tf.scalar(.5)).dataSync(),3)})}}],[{key:"createModel",value:function(e,t){var n=tf.initializers.varianceScaling({distribution:"normal",mode:"fanIn",scale:t,seed:e}),i=tf.input({shape:[4]}),r=o.createDensityTopology(i,n);return r=tf.layers.dense({activation:"tanh",kernelInitializer:tf.initializers.glorotNormal({seed:e}),units:3}).apply(r),tf.model({inputs:i,outputs:r})}},{key:"createDensityTopology",value:function(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:8,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:8,r=0;r<n;r++){var o=tf.layers.dense({activation:"sigmoid",kernelInitializer:t,units:i}).apply(e);e=tf.layers.concatenate({}).apply([e,o])}return e}}]),o}(),f=function(){function t(e){if(r(this,t),"function"!=typeof e)throw new Error("Callback "+e+" should be a function");this._callback=e,this._isStopped=!1,this._onStopCallback=null,this._rId=null,this._timePrevious=0,this.frame=0,this.frameRate=1}return s(t,[{key:"start",value:function(){var e=performance.now();this.frame=0,this._isStopped=!1,this._timePrevious=e,this._next(e)}},{key:"stop",value:function(e){this._isStopped?e():(this._isStopped=!0,cancelAnimationFrame(this._rid),"function"==typeof e&&requestAnimationFrame(e))}},{key:"_next",value:function(e){if(!this._isStopped){var t=(e-this._timePrevious)/1e3;this._timePrevious=e,this.frameRate=1/t,requestAnimationFrame(this._next.bind(this)),this._callback(this.frame++,e)}}}]),t}(),g=function(e){function i(e,t){r(this,i);var n=a(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return n.context=n.element.getContext("2d"),n.imageData=null,n.model=null,n.settingsComponent=t,n.animationLoop=new f(function(e){return n._render(e)}),n}return o(i,h),s(i,[{key:"download",value:function(){var e=this.settingsComponent,t=e.height,i=e.seed+"-"+e.time+"-"+e.sharpness+"-"+e.width+"x"+t+".png";this.context.canvas.toBlob(function(e){if("msSaveBlob"in window.navigator)window.navigator.msSaveBlob(e,i);else{var t=(window.URL||window.webkitURL).createObjectURL(e),n=document.createElement("a");n.style.display="none",n.download=i,n.href=t,document.body.appendChild(n),n.click(),requestAnimationFrame(function(){document.body.removeChild(n),(window.URL||window.webkitURL).revokeObjectURL(t)})}},"image/png")}},{key:"start",value:function(){var e=this.settingsComponent,t=e.height,n=e.seed,i=e.sharpness,r=e.width;this.element.height=t,this.element.width=r,this.imageData=this.context.createImageData(r,t),this.model=new p(n,i),this.animationLoop.start(),this.trigger("start")}},{key:"stop",value:function(e){var t=this;this.animationLoop.stop(function(){t.model.dispose(),"function"==typeof e&&e()})}},{key:"_render",value:function(e){if(e*this.settingsComponent.batchSize>=this.settingsComponent.pixelCount)return this.stop(),this.trigger("render",1),void this.trigger("finish");var t=e*this.settingsComponent.batchSize,n=Math.min(1,t/(this.settingsComponent.pixelCount-1));this._renderPixel(t),this.trigger("render",n)}},{key:"_renderPixel",value:function(s){var a=this,u=this.settingsComponent.aspect,h=4*s,e=Math.min(this.settingsComponent.batchSize,this.settingsComponent.pixelCount-s),t=new Array(e).fill().map(function(e,t){var n=(s+t)%a.element.width,i=Math.floor((s+t)/a.element.width)%a.element.height,r=l(-1,1,n/(a.element.width-1))*u,o=l(-1,1,i/(a.element.height-1));return[r,o,Math.sqrt(r*r+o*o),a.settingsComponent.time]});this.model.predict(t).forEach(function(e,t){var n=d(e,3),i=n[0],r=n[1],o=n[2],s=h+4*t;a.imageData.data[s+0]=255*i,a.imageData.data[s+1]=255*r,a.imageData.data[s+2]=255*o,a.imageData.data[s+3]=255}),this.context.putImageData(this.imageData,0,0)}}]),i}(),m=function(e){function n(e){r(this,n);var t=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.elementProgress=t.getElement("report-progress"),t.elementTimeRemaining=t.getElement("report-time-remaining"),t.timePrevious=0,t}return o(n,h),s(n,[{key:"start",value:function(){this.timeElapsed=0,this.timePrevious=performance.now(),this.update(0)}},{key:"update",value:function(e){var t=performance.now(),n=(t-this.timePrevious)/1e3;this.timeElapsed+=n;var i,r=(1-e)*(1/e*this.timeElapsed);this.elementProgress.innerText=(100*e).toFixed(2)+"%",this.elementTimeRemaining.innerText="~"+((i=r)<60?i.toFixed(0)+"s":i<3600?(i/60).toFixed(0)+"m":(i/3600).toFixed(2)+"h")+" remaining",this.timePrevious=t}}]),n}(),_=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;r(this,e),this.deviceStrength=t},v=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:320,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:320;r(this,n),this.height=t,this.width=e}return s(n,[{key:"setResolutionFromString",value:function(e){var t=e.split(/x/g).map(function(e){return Number.parseInt(e)}),n=d(t,2),i=n[0],r=n[1];r&&i&&(this.height=r,this.width=i)}}]),n}(),y=[128,512,1024,2048],S=function(e){function i(e){r(this,i);var t=a(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));t._inputHeight=t.element.elements.height,t._inputHeight.min=1,t._inputWidth=t.element.elements.width,t._inputWidth.min=1,t._inputSeed=t.element.elements.seed,t._inputSeed.max=u.SEED_MAX,t._inputSeed.min=u.SEED_MIN,t._inputSeed.step=1,t._inputTime=t.element.elements.time,t._inputTime.step=1/Math.pow(10,u.TIME_PRECISION),t._inputSharpness=t.element.elements.sharpness,t._inputSharpness.max=u.SHARPNESS_MAX,t._inputSharpness.min=u.SHARPNESS_MIN,t._buttonRandomize=t.element.elements.randomize,t._inputDeviceStrength=t.element.elements["device-strength"],t._inputDeviceStrength.min=0,t._inputDeviceStrength.max=y.length-1,t._inputDeviceStrength.step=1,t._deviceSettings=new _,t._imageSettings=new v,t._renderSettings=new u,t._updateFields();var n=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,n=void 0;return function(){n&&clearTimeout(n),n=setTimeout(function(){return e()},t)}}(t._handleInputUpdate.bind(t));return t.element.addEventListener("input",function(e){e.target!==t._inputDeviceStrength&&e.target!==t._inputSeed&&e.target!==t._inputTime&&e.target!==t._inputSharpness||n()}),t.element.addEventListener("change",function(e){e.target!==t._inputWidth&&e.target!==t._inputHeight||n()}),t.element.addEventListener("click",function(e){"resolution-preset"===e.target.name&&(t._imageSettings.setResolutionFromString(e.target.dataset.resolution),t.trigger("change"))}),t._buttonRandomize.addEventListener("click",function(){return t._randomize()}),t}return o(i,h),s(i,[{key:"update",value:function(){t.getRenderSettings()&&(this._renderSettings=t.getRenderSettings()),this._updateFields()}},{key:"persist",value:function(){t.persist(this._renderSettings)}},{key:"_handleInputUpdate",value:function(){this.element.reportValidity()&&(this._hydrate(),this.persist(),this.trigger("change"))}},{key:"_hydrate",value:function(){this._renderSettings.seed=Number.parseInt(this._inputSeed.value),this._renderSettings.time=Number.parseFloat(this._inputTime.value),this._renderSettings.sharpness=Number.parseInt(this._inputSharpness.value),this._imageSettings.height=Number.parseInt(this._inputHeight.value),this._imageSettings.width=Number.parseInt(this._inputWidth.value),this._deviceSettings.deviceStrength=Number.parseInt(this._inputDeviceStrength.value)}},{key:"_randomize",value:function(){this._renderSettings.randomize(),this.persist(),this.trigger("change")}},{key:"_updateFields",value:function(){this._inputSeed.value=this._renderSettings.seed,this._inputTime.value=this._renderSettings.time,this._inputSharpness.value=this._renderSettings.sharpness,this._inputHeight.value=this._imageSettings.height,this._inputWidth.value=this._imageSettings.width,this._inputDeviceStrength.value=this._deviceSettings.deviceStrength}},{key:"aspect",get:function(){return this.width/this.height}},{key:"batchSize",get:function(){return y[this._deviceSettings.deviceStrength]?y[this._deviceSettings.deviceStrength]:y[0]}},{key:"height",get:function(){return this._imageSettings.height}},{key:"pixelCount",get:function(){return this.height*this.width}},{key:"seed",get:function(){return this._renderSettings.seed}},{key:"time",get:function(){return this._renderSettings.time}},{key:"sharpness",get:function(){return this._renderSettings.sharpness}},{key:"width",get:function(){return this._imageSettings.width}}]),i}(),e=new(function(e){function n(e){r(this,n);var t=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._buttonDownload=t.getElement("button-download"),t._rendererReport=new m(t.getComponentElement("image-renderer-report")),t._settings=new S(t.getComponentElement("settings")),t._settings.on("change",function(){return t.restart()}),t._settings.update(),t._renderer=new g(t.getComponentElement("image-renderer"),t._settings),t._renderer.on("start",function(){t._rendererReport.start(),t._buttonDownload.disabled=!0}),t._renderer.on("render",function(e){t._rendererReport.update(e)}),t._renderer.on("finish",function(){t._buttonDownload.disabled=!1}),t._buttonDownload.addEventListener("click",function(){t._buttonDownload.disabled||t._renderer.download()}),t}return o(n,h),s(n,[{key:"restart",value:function(){var e=this;this._settings.update(),this.stop(function(){return e.start()})}},{key:"start",value:function(){this._settings.persist(),this._renderer.start()}},{key:"stop",value:function(e){this._renderer.stop(e)}}]),n}())(document.querySelector('[data-component="app"]'));e.start(),t.on("change",function(){return e.restart()}),window.addEventListener("beforeunload",function(){return e.stop()})}();
